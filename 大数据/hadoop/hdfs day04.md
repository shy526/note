# hdfs
- 流式数据访问模式来存储超大文件
- 运行在商用硬件集群上

## 设计
2. 流式数据访问
  - 一次写入多次读写(最高效的访问模式)
3. 商用硬件
  - 价格低
  - 节点故障没有明显中断
4. 低时间延迟的数据访问
  - 为高数据吞吐量应用优化
    - 以提高时间延迟为代价
  - 低延迟可使用hbase
5. 大量的小文件
  - namenode
    - 将元数据存储在内存中
      - 能够存储的文件总数受限于namenode的内存熔炉
      - 目录,和数据块的存储信息大约占150个字节
6. 多用户写入,任意修改文件
  - 只支持单个写入者
    - 新数据只会在文件末尾

# 概念

## 数据块
- 磁盘进行读写的最小单位
  - 通过磁盘块来管理文件系统中的块
- 文件系统的大小可以时磁盘块的整数倍
  -  文件系统块一般有几千字街,磁盘块为512字节

## hdfs 中的块
- bolck
  - 默认为128mb
  - 与磁盘上的文件系统相似
- chunk
  - hdfs中的独立存储单元
  - 一个文件不会占据整个chunk

> bolck 为什么那么大?
>> 最小化寻址开销
>> 也不能设置过大
>> map任务只处理一个块中的数据,任务变少
- bolck的好处
  - 文件大小可以大于任意节点磁盘的容量
  - 简化存储子系统的设计
    - 简化存储管理
    - 消除对元数据的顾虑
    - 适合进行备份(提高了容错能力和可用性)
      - 默认 备份3个

- namenode
  - 管理节点
    - 管理文件系统的命名控件
      - 每个块所有在数据节点的信息
        - 会在系统启动时根据数据节点信息重建
      - 维护文件系统树及整课树内的所有的文件和目录
        - 保存在本地磁盘上(永久保存)
          - 形式为命名控件镜像和编辑日志文件
    - 没有namenode 文件系统将无法使用
- datanode
  - 工作节点
  - 存储并检索数据块(受namenode和客户端调度)
  - 定期向namenode节点发送存储块的列表

# namenode容错

1. 备份那些组成文件系统元数据持久状态的文件
    - 通过配置使namenode在多个文件系统上保存元数据的持久状态
    - 写操作实时同步,且是原子操作
    - 将持久状态写入本地磁盘同时写入一个远程挂载点

2. 运行一个辅助namenode
    - 不能被用做namenode
    - 定期合并编辑日志和命名控件镜像
    - 一般运行在独立物理计算机上
      - 需要大量cpu时间
      - 需要namenode一样多的内存来执行合并操作
    - 保存后并和的命名控件和编辑日志的副本
      - 并会在namenode故障时启用
    - 保存状态滞后于主节点
      - 主节点全部失效时,难免会丢失数据
      - 一般把主节点元数据复制到辅助namenode并作为新节点
    > 可以使用热备份namenode进行替代

## 块缓存
- 对于频繁访问的块,可能被显式的缓存在datanode内存中
- 默认:一个块仅会缓冲在一个datanode节点上
  - 可以针对每个文件配置datanode的数量
  - 作业调度通过在缓存块的datanode上运行任务
    - 提高读操作的性能
> 可以通过缓冲池中增加一个cache directive 来告诉namenode

## 联邦hdfs
- 2.x引入
- namennode在内存中保存文件系统中每个文件和每个数据块的引用关系
  - 横向扩展时,内存将成为瓶颈
- 允许添加namenode实现扩展
  - 每个namenode管理文件系统命名空间的一部分
- 每个namenode需要维护一个命名空间卷`namespace volume`
  - 命名空间卷
    - 元数据
    - 数据库池
      - 命名空间下文件的所有数据库
    - 互相独立,两两不同信,互不影响
    - datanode需要注册到每个namenode并且存储这来自多个数据块池中的数据块池
> 访问联邦 hdfs集群 客户端需要使用客户端挂载数据表将文件路径映射到namenode
> 可以通过ViewFileSystem和viewfs://URI 进行配置和管理

## hdfs 高可用
- namenode通过提高容错依旧存无法实现文件系统的高可用
  - namenode任然纯在单点失效的问题
    - 失效后 导致 Mapreuce均无法读写或列举文件
  - 启动一个拥有元数据副本的namenode
  - 并配置datanode和客户端
    - 新的namenode需要满足一下情况才能相应服务
      - 将命名空间映像导入内存
      - 重演编辑日志
      - 接收足够多个的来自datanode的数据库报告并退出安全模式
      - 对于大型系统需要30分钟或者更长的时间
- 配置一对活动-备份(active-standby)namenode
  - 当活动namenode失效,备份namenode就会接管他的任务并开始服务
  - 不会有明显中断

- 高可用实现
  1. namenode之间需要通过高可用那个共享存储实现编辑日志的共享
  2. dtanodoe需要同时向连个nomenode发送数据块处理报告
  3. 客户端需要特定的机制来吃力namenode的失效问题
  4. 辅助namenode的角色被备用namenode保护
    - namenode命名空间周期性检查点
  - 策略选择
    1. NFS过滤器
    2. 群体日志管理(QJM)


```blog
{type: "Hadoop", tag:"大数据,Hadoop,java",title:"hdfs概念"}
```
